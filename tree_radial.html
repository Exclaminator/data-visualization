<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Trees</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="main.css" />
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <!-- <script src="./d3.v4.min.js"></script> -->
        <script src="./Collatz.js"></script>
        <script src="./ColorScheme.js"></script>
        <script src="./breadcrumb.js"></script>
        <script src="./d3.slider.js"></script>
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <link rel="stylesheet" href="./d3.slider.css" />
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    </head>
    <body>
        <div class="row" width="100%" >
            <svg id="breadcrumbs" class="col-md-12" style="height: 30px;"></svg>
        </div>
        <form>
            <div id="toolrow" class="row" style="height: 30px;">
                    
                <div class="form-group">
                        <label for="exampleFormControlSelect2">Mode: </label>
                        <input  type="button" class="form-button" name="fastCollatz" value="Reduced" onclick="location.href = location.toString().replace(location.search, '') + '?fast'"/>
                        <input  type="button" class="form-button" name="defaultCollatz" value="Explicit" onclick="location.href = location.toString().replace(location.search, '')"/>
                    </div>
                    <div id="inspection" class="col-md-3">20</div>
                        <!-- <div class="form-group">
                            <label for="colors-slider">Colors (= modulo)</label>
                            <input type="range" class="form-control-range" id="colors-slider" min="1" max="18" onchange="changeNumColors(this.value)">
                        </div>   -->
                    </div>
                <svg id="legend" class="col-md-6"></svg>
            </div>
        </form>
        <div id="visrow" class="row">
            <svg id="radial_tree" class="col-md-6"></svg>
            <svg id="barchart" class="col-md-6"></svg>
        </div>
    </body>


    
                    <!---
                        - Mode
                        - Colors
                        - Width bar chart (interact-drag barchart = nicer ux?)
                        - Depth tree
                    -->
                    <!-- <div class="form-group">
                        <label for="exampleFormControlSelect2">Collatz Conjecture mode</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="collatz-mode" id="gridRadios1" value="fast" checked>
                            <label class="form-check-label" for="gridRadios1">Fast Collatz (skip trivial even numbered steps)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="collatz-mode" id="gridRadios2" value="normal">
                            <label class="form-check-label" for="gridRadios2">Default Collatz</label>
                        </div>
                    </div> -->
                    <!-- <div class="form-group">
                        <label for="treedepth-slider">Tree depth</label>
                        <input type="range" class="form-control-range" id="treedepth-slider" min="1" max="20" onmouseup="changeTreeDepth(this.value)">
                    </div>
                    <div class="form-group">
                        <label for="barchartwidth-slider">Barchart width (columns)</label>
                        <input type="range" class="form-control-range" id="barchartwidth-slider"  min="1" max="15">
                    </div> -->

    <script>
        console.log(Date.now());

        let rootStack = [];
        let maxTreeDepthRelative = 15;
        var barChart_numHorizontalElements = 200;

        const height = window.innerHeight*5/6;
        const width = window.innerWidth/2 - 50;

        const radius = width / 2 - 60;
        const dy = 30;
        const dx = 10;

        // colorscheme size = m, max is 20.
        let m = 5;
        let colorScheme = new ModuloColorScheme(m);

        // init UI positions
        //$("#colors-slider")[0].value = m;
        // $("#treedepth-slider")[0].value = maxTreeDepthRelative;



        let conjecture = new URLSearchParams(window.location.search).has("fast")
            ? new CollatzConjectureFast()
            : new CollatzConjectureDefault();

        let currentRoot = new CollatzNumberSimple(conjecture, 1);
        
        // make the visualization
        makeRadialTree(currentRoot);
        barChart(currentRoot);

        breadcrumb = d3.breadcrumb()
            .container('#breadcrumbs')   
            .padding(5)
            .wrapWidth(window.innerWidth)  // hint:  set 100 
            .height(28)
            .fontSize(14)
            .marginLeft(0)
            .marginTop(4)
            .leftDirection(false);
        // show breadcrumbs
        
        // goes wrong with updateing witht he first 10 elements?????
        rootStack = [currentRoot.get(1), currentRoot.get(2), currentRoot.get(3), currentRoot.get(4), currentRoot.get(5), currentRoot.get(6), currentRoot.get(7), currentRoot.get(8), currentRoot.get(9), currentRoot.get(1), currentRoot.get(2), currentRoot.get(3), currentRoot.get(4), currentRoot.get(5), currentRoot.get(6), currentRoot.get(7), currentRoot.get(8), currentRoot.get(9), currentRoot.get(1), currentRoot.get(2), currentRoot.get(3), currentRoot.get(4), currentRoot.get(5), currentRoot.get(6), currentRoot.get(7), currentRoot.get(8), currentRoot.get(9)];
        function showBreadcrumbs() {
            var objectstack = rootStack.concat(currentRoot).map(node => {
                return {text: node.value(), fill: colorScheme.forNumber(node.value())};
            });
            breadcrumb.show(objectstack);
        }
        showBreadcrumbs();
        
        function showLegend() {
            
            d3.select("#legend").remove();
            d3.select("body").select("#toolrow")
                .append("svg")
                .attr("id", "legend")
                .attr("class", "col-md-6");

            const svg = d3.select("#legend");
            var fw = parseInt(svg.style("width"));
            var fh = parseInt(svg.style("height"));
            const shemeObjects = colorScheme.getSchemeObjects();
            const t = shemeObjects.length
            const m = colorScheme.getModulo();
            const dx = fw / t;
            
            
            var block = svg.selectAll("g").data(shemeObjects).enter().append("g")
                 .attr("transform", function(d, i) { return "translate(" + i * dx + ", 0)"; });

            block.append("rect")
                .attr("width", dx)
                .attr("height", 30)
                .attr("fill", (d,i) => colorScheme.forNumber(i));

            block.append("text")
                .attr("x", Math.max(0, dx/2 - Math.min(15, m)))
                .attr("y", 30 / 2)
                .attr("dy", ".35em")
                .attr("fill", "white")
                .text(function(d) { return d.value; });
            

            svg.append("rect")
                .datum([{value: "bloep"}])
                .attr("x", fw*m/t + dx/2)
                .attr("y", 0)
                .attr("width", 5)
                .attr("height", 30)
                .attr("r", 5)
                .attr("id", "slider")
                .attr("cursor", "ew-resize")
                .style("fill", "white")
                .style("stroke", "black")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            function dragstarted(d) {
                d3.select("#slider").raise().classed("active", true);
            }

            function dragged(d) {
                d3.select("#slider").attr("x", d.x = Math.max(0, Math.min(d3.event.x, 19*dx)));
                console.log(Math.floor(d3.event.x/dx));
                var m = Math.floor(d3.event.x/dx);
                colorScheme.changeModulo(m);
                block.select("rect").attr("fill", (d, i) => { return colorScheme.forNumber(i)});
            }

            function dragended(d) {
                d3.select("#slider").classed("active", false);
                var m = Math.floor(d3.event.x/dx);
                // d3.select("#slider").attr("x", d.x = Math.max(0, Math.min(m*dx, 19*dx)));
                changeNumColors(m);
            }

            // var drag = d3.behavior.drag()
            //     .origin(function(d) { return d; })
            //     .on("drag", dragmove);
            // var circle = svg.append("circle")
            //     .attr("r", radius)
            //     .attr("cy", function(d) { return d.y; })
            //     .attr("cx", function(d) { return d.x; })
            //     .style("cursor", "ew-resize")
            //     .call(drag);
        

            // for (var i = 0; i < m; i++) {
            //     g.append("rect")
            //         .attr("x", i*dx)
            //         .attr("y", 0)
            //         .attr("width", dx)
            //         .attr("height", 30)
            //         // .attr("title", innernode.value())
            //         // .attr("class", "bar"+innernode.value() + " cBar"+node.value())
            //         // .on("mouseover", (innernode => () => highlight(node, innernode))(innernode))
            //         // .on("click", (innernode => () => updateRoot(innernode))(innernode))
            //         .attr("fill", colorScheme.forNumber(i));
            // }
        }
        showLegend();

        function changeNumColors(newNumColors) {
            colorScheme.changeModulo(parseInt(newNumColors));

            unlight();
            d3.select("#radial_tree")
                .selectAll("circle")
                .attr("fill", d => (d.data.value() === currentRoot.value())? colorScheme.forRoot() : colorScheme.forNumber(d.data.value()));

            highlight();
            // d3.select("#barchart").selectAll("rect")
            //     .attr("fill", (innernode.value() === currentRoot.value()) ? colorScheme.forRoot() : colorScheme.forNumber(innernode.value()));
            showBreadcrumbs();
            //showLegend();
            barChart(currentRoot);
        }

        function changeTreeDepth(newTreeDepth) {
            redraw(currentRoot, barChart_numHorizontalElements, newTreeDepth)
        }

        // TODO: add conjecture input
        function redraw(_root, _amount, _treeDepth) {
            barChart_numHorizontalElements = _amount;

            if (maxTreeDepthRelative != _treeDepth) {
                console.log(`new depth: ${_treeDepth}, old depth = ${maxTreeDepthRelative}`)
                maxTreeDepthRelative = _treeDepth;
            }

            makeRadialTree(_root);
            barChart(_root);
            showBreadcrumbs();
        }

        /**
         *  @param newRoot The selected node, if same as current root will reset to previous root
         */
        function updateRoot(newRoot) {
            /* store/load the root node */
            if (rootStack.length > 0 && newRoot === currentRoot) {
                // clicked on root
                const nod = rootStack.pop();
                makeRadialTree(nod);
                currentRoot = nod;
            } else {
                rootStack.push(currentRoot);
                makeRadialTree(newRoot);
                currentRoot = newRoot;
            }

            barChart(currentRoot);
            showBreadcrumbs();
        }

        function makeRadialTree(collatzNode) {
            let tree = data => d3.tree()
                .size([Math.PI * 2, radius])
                .separation((a, b) => (a.parent.name === b.parent.name ? 1 : 2) / a.depth)
                (d3.hierarchy(data, d => {
                    if (d.depth() < maxTreeDepthRelative + collatzNode.depth() - Math.log(d.depth())) { // + collatzNodeAsRoot.depth()) {
                        return d.children();
                    } else {
                        return null;
                    }
                }));

            const root = tree(collatzNode);

            d3.select("#radial_tree").remove();
            d3.select("body").select("#visrow")
                .insert("svg", "#barchart")
                .attr("id", "radial_tree");


            const svg = d3.select("#radial_tree")
                .style("height", "100%")
                .style("padding", "10px")
                .style("box-sizing", "border-box")
                .style("font", "10px sans-serif");

            const g = svg.append("g");

            const link = g.append("g")
                .attr("fill", "none")
                .attr("stroke", "#555")
                .attr("stroke-opacity", 0.4)
                .attr("stroke-width", 1.5)
                .selectAll("path")
                .data(root.links()).enter()
                    .append("path")
                    .attr("d", d3.linkRadial()
                    .angle(d => d.x)
                    .radius(d => d.y));

            const node = g.append("g")
                .attr("stroke-linejoin", "round")
                .attr("stroke-width", 3)
                .selectAll("g")
                .data(root.descendants().reverse())
                .enter().append("g")
                .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`);
            
            node.append("circle")
                .attr("fill", d => (d === root)? colorScheme.forRoot() : colorScheme.forNumber(d.data.value()))
                .attr("r", 7)
                .attr("id", d => "circle" + d.data.value())
                // .attr("data-value", d => d.data.value())
                // .attr("data-root", root.data.value());

            function isEven(n) {
                return !(n & 1);
            }

            node.append("text")
                .attr("dy", d => {
                    if (!d.children) {
                        return "0.4em";
                    }
                    return isEven(d.depth) ? "-0.5em" : "1.2em"
                })
                .attr("x", d => d.x < Math.PI ? 6 : -6)
                .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
                .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
                .text(d => d.data.value())
                .clone(true).lower()
                .attr("stroke", "white")
                .attr("text-align", "left");

            const box = g.node().getBBox();
            
            svg
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `${box.x} ${box.y} ${box.width} ${box.height}`);
                
            // update onclick and mouse events here.
            d3.select("#radial_tree").selectAll("circle")
                .on("mouseover", d => highlight(d.data))
                .on("click", d => updateRoot(d.data));

            return svg.node();
        }
        
        //////
        // mouse-in and -out functions
        //////

        /**
         * Usage: highlight(node) when hovering over node in tree, highlight(node, inner) when hovering over the barchart
        * @param node "the element of the column (topmost) i.e. elem that generates the column"
        * @param innernode "the element in the column you're hovering over"
        */
        function highlight(node, innernode) {

            // save what is going to be highlighted
            if (node){
                this.highlighted = node;
            }

            // nothing highlighted, so nothing to do
            if (this.highlighted === undefined) {
                return;
            }


            // handle missing innernode arg (highlight node in tree and whole bar in barchart)
            if (!innernode) {
                innernode = this.highlighted;
            }

            // sticky-highlighting: unlight everything only on new highlight command
            unlight();

            let nd = this.highlighted;
            for (var i = 0; i <= this.highlighted.depth(); i++) {
                let color = nd.value() === innernode.value() ? colorScheme.forSpecial(0) : colorScheme.forSpecial(1);

                d3.select("#radial_tree").select("#circle"+nd.value()).style("stroke", color);
                d3.select("#barchart").selectAll(".bar"+nd.value()).style("stroke", color);
                nd = nd.parent();
            }
        }

        
        function unlight() {
            d3.select("#radial_tree").selectAll("circle").style("stroke", "none");
            d3.select("#barchart").selectAll("rect").style("stroke", "none");
        }

        ///////
        // Bar chart
        ///////
        function barChart(root) {
            let node = root;
            let maxDepth = 0;
            for (let i = 0; i < barChart_numHorizontalElements; i++) {
                maxDepth = Math.max(node.depth(), maxDepth);
                node = node.next();
            }

            // don't remove the +1, hacky reasons
            const squareHeight = (height-100) / (maxDepth + 1);
            const squareWidth = width / barChart_numHorizontalElements;

            d3.select("#barchart").remove();
            var svgContainer = d3.select("#visrow").append("svg")
                .attr("id", "barchart")
                .attr("width", width)
                .attr("height", (height - 50));
            
            node = root;
            let innernode = root;

            for (var i = 0; i < barChart_numHorizontalElements; i++) {
                innernode = node;
                for (var j = 0; j <= node.depth(); j++) {
                    svgContainer.append("rect")
                        .attr("x", i*squareWidth)
                        //.attr("y", height - (j*squareHeight))     // inverted version
                        .attr("y", height - 50 - (node.depth()+1)*squareHeight + (j*squareHeight))
                        .attr("width", squareWidth)
                        .attr("height", squareHeight)
                        .attr("title", innernode.value())
                        .attr("class", "bar"+innernode.value() + " cBar"+node.value())
                        .on("mouseover", (innernode => () => highlight(node, innernode))(innernode))
                        .on("click", (innernode => () => updateRoot(innernode))(innernode))
                        .attr("fill", (innernode.value() === root.value()) ? colorScheme.forRoot() : colorScheme.forNumber(innernode.value()));
                    innernode = innernode.parent();
                }
                node = node.next();
            }
        }
    </script>

</html>