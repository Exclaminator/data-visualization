<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Trees</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="main.css" />
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <!-- <script src="./d3.v4.min.js"></script> -->
        <script src="./Collatz.js"></script>
        <script src="./utils.js"></script>
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    </head>
    <body>
        <div>
            <form>
                <!---
                    - Mode
                    - Colors
                    - Width bar chart (interact-drag barchart = nicer ux?)
                    - Depth tree
                -->
                <div class="form-group">
                    <label for="exampleFormControlSelect2">Collatz Conjecture mode</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="collatz-mode" id="gridRadios1" value="fast" checked>
                        <label class="form-check-label" for="gridRadios1">Fast Collatz (skip trivial even numbered steps)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="collatz-mode" id="gridRadios2" value="normal">
                        <label class="form-check-label" for="gridRadios2">Default Collatz</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="colors-slider">Colors (= modulo)</label>
                    <input type="range" class="form-control-range" id="colors-slider" min="1" max="18" onchange="changeNumColors(this.value)">
                </div>
                <div class="form-group">
                    <label for="treedepth-slider">Tree depth</label>
                    <input type="range" class="form-control-range" id="treedepth-slider" min="1" max="15">
                </div>
                <div class="form-group">
                    <label for="barchartwidth-slider">Barchart width (columns)</label>
                    <input type="range" class="form-control-range" id="barchartwidth-slider"  min="1" max="15">
                </div>
            </form>
        </div>

        <svg id="radial_tree"></svg>
        <svg id="barchart"></svg>
    </body>

    <script>
        console.log(Date.now());

        const maxDepthRelative = 17;

        // const diagonal = d3.linkHorizontal().x(d => d.y).y(d => d.x);
        // const margin = ({top: 10, right: 120, bottom: 10, left: 40});

        const height = window.innerHeight;
        const width = window.innerWidth/2 - 50;
        const radius = width / 2 - 60;

        const dy = 30;
        const dx = 10;

        // colorscheme size = m, max is 20.
        let m = 5;
        const colorScheme = ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"];

        var amount = 200;

        let rootStack = [];
        

        // const tree = d3.tree().nodeSize([dx, dy]);

        function isPowTwo(number) {
            return (number !== 0) && ((number & (number - 1)) === 0);
        }

        // init UI positions
        $("#colors-slider")[0].value = m;

        function changeNumColors(newNumColors) {
            redraw(newNumColors, currentRoot, amount);
        }

        // TODO: add conjecture input
        function redraw(_m, _root, _amount) {
            m = _m;
            amount = _amount;
            // TODO: redraw tree logic here
            makeRadialTree(_root);
            barChart(_root);
        }

        let conjecture = new CollatzConjectureFast();
        let rootNodeCollatz = new CollatzNumberSimple(conjecture, 1);
        let node = makeRadialTree(rootNodeCollatz);
        let currentRoot = rootNodeCollatz;

        /**
         *  nd = new root
         *  root = old root
         */

        function updateRoot(nd, root) {
            /* store/load the root node */
            let node;
            if (rootStack.length > 0 && nd == root) {
                // clicked on root
                const nod = rootStack.pop();
                node = makeRadialTree(nod);
                barChart(nod);
                currentRoot = nod;
            } else {
                rootStack.push(root);
                node = makeRadialTree(nd);
                barChart(nd);
                currentRoot = nd;
            }
            //replaceTree(node);
        }

        function makeRadialTree(collatzNode) {
            console.log(collatzNode);
            // d3.select("svg").innerHtml("");

            let tree = data => d3.tree()
                .size([Math.PI * 2, radius])
                .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth)
                (d3.hierarchy(data, d => {
                    if (d.depth() < maxDepthRelative + collatzNode.depth() - Math.log(d.depth())) { // + collatzNodeAsRoot.depth()) {
                        return d.children();
                    } else {
                        return null;
                    }
                }));

            const root = tree(collatzNode);

            d3.select("#radial_tree").remove();
            d3.select("body")
                .insert("svg", "#barchart")
                .attr("id", "radial_tree");


            const svg = d3.select("#radial_tree")
                .style("height", "100%")
                .style("padding", "10px")
                .style("box-sizing", "border-box")
                .style("font", "10px sans-serif");

            const g = svg.append("g");

            const link = g.append("g")
                .attr("fill", "none")
                .attr("stroke", "#555")
                .attr("stroke-opacity", 0.4)
                .attr("stroke-width", 1.5)
                .selectAll("path")
                .data(root.links())
                .enter().append("path")
                .attr("d", d3.linkRadial()
                    .angle(d => d.x)
                    .radius(d => d.y));

            const node = g.append("g")
                .attr("stroke-linejoin", "round")
                .attr("stroke-width", 3)
                .selectAll("g")
                .data(root.descendants().reverse())
                .enter().append("g")
                .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`);
            
            node.append("circle")
                .attr("fill", d => (d == root)? colorScheme[m+1] : colorScheme[d.data.value()%m])
                .attr("r", 7)
                .attr("id", d => "circle" + d.data.value())
                .attr("data-value", d => d.data.value())
                .attr("data-root", root.data.value());

            function isEven(n) {
                return !(n & 1);
            }

            node.append("text")
                .attr("dy", d => {
                    if (!d.children) {
                        return "0.4em";
                    }
                    return isEven(d.depth) ? "-0.5em" : "1.2em"
                })
                .attr("x", d => d.x < Math.PI ? 6 : -6)
                .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
                .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
                .text(d => d.data.value())
                .clone(true).lower()
                .attr("stroke", "white")
                .attr("text-align", "left");

            const box = g.node().getBBox();
            
            svg
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `${box.x} ${box.y} ${box.width} ${box.height}`);
                
            
            // update onclick and mouse events here.
            d3.select("#radial_tree").selectAll("circle")
            .on("mouseover", function(d) {
                const nd = rootNodeCollatz.get(parseInt(this.dataset.value));
                (highlight(nd, nd))();
            })
            .on("click", function(d) {
                const nd = rootNodeCollatz.get(parseInt(this.dataset.value));
                const root = rootNodeCollatz.get(parseInt(this.dataset.root));
                updateRoot(nd, root);
            });

            return svg.node();
        }
        
        //////
        // mouse-in and -out functions
        //////
        var prevHighlightedNode;
        var prevHighlightedinnernode;

        /**
        * @param node "the element of the column (topmost) i.e. elem that generates the column"
        * @param innternode "the element in the column you're hovering over"
        */
        function highlight(node, innernode) {
            return _ => {
                unlight();
                var nd = node;
                for (var i = 0; i <= node.depth(); i++) {
                    d3.select("#radial_tree").select("#circle"+nd.value())
                        .style("stroke", (nd.value() == innernode.value()? colorScheme[m] : colorScheme[m+1]));
                    d3.select("#barchart").selectAll(".bar"+nd.value())
                        .style("stroke", (nd.value() == innernode.value()? colorScheme[m] : colorScheme[m+1]));
                    nd = nd.parent();
                }
            }
        }

        
        function unlight() {
            d3.select("#radial_tree").selectAll("circle").style("stroke", "none");
            d3.select("#barchart").selectAll("rect").style("stroke", "none");
        }

        ///////
        // Bar chart
        ///////
        function barChart(root) {
            console.log(root);      
            var node = root;
            var maxDepth = 0;
            for (var i = 0; i < amount; i++) {
                maxDepth = Math.max(node.depth(), maxDepth);
                node = node.next();
            }

            // don't remove the +1, hacky reasons
            const squareHeight = height / (maxDepth + 1);
            const squareWidth = width / amount;

            d3.select("#barchart").remove();
            var svgContainer = d3.select("body").append("svg")
                .attr("id", "barchart")
                .attr("width", width)
                .attr("height", height);
            
            node = root;
            var innernode = root;

            for (var i = 0; i < amount; i++) {
                innernode = node;
                for (var j = 0; j <= node.depth(); j++) {
                    svgContainer.append("rect")
                        .attr("x", i*squareWidth)
                        //.attr("y", height - (j*squareHeight))     // inverted version
                        .attr("y", height - (node.depth()+1)*squareHeight + (j*squareHeight))
                        .attr("width", squareWidth)
                        .attr("height", squareHeight)
                        .attr("title", innernode.value())
                        .attr("class", "bar"+innernode.value() + " cBar"+node.value())
                        .on("mouseover", highlight(node, innernode))
                        // .on("mouseout", delight(node, innernode))
                        .on("click", (innernode => {
                            return _ => {
                                updateRoot(innernode, root);
                            }
                        })(innernode))
                        .attr("fill", (innernode.value() == root.value()) ? colorScheme[m+1] : colorScheme[innernode.value() % m]);
                    innernode = innernode.parent();
                }
                node = node.next();
            }
        }
        barChart(rootNodeCollatz);
    </script>

</html>